# SportsAgent Design Notes

## Current Intentions and Architecture

- **LangGraph Workflow** (`src/sportsagent/workflows/graphs/playereval/workflow.py`):
  - **Entry Node**: Initial validation.
  - **Query Parser Node**: Parses user intent.
  - **Retriever Node**: Fetches NFL data (using `nflreadpy`). Supports player-specific and position-based queries (e.g., "all QBs").
  - **Analyzer Node**: Wraps the `AnalyzerAgent`.
  - **Approval Node**: Pass-through node for Human-in-the-Loop (HITL) interruptions.
  - **Visualization Node**: Generates Plotly charts using LLM.
  - **Exit Node**: Handles completion.

- **Graph Routing & Loops**:
  - The workflow implements a **Retrieval Loop** with **Human Approval**: `Analyzer` $\rightarrow$ `Approval` $\rightarrow$ `Retriever`.
  - If the `AnalyzerAgent` determines it needs more data (e.g., for comparison), it calls the `request_more_data` tool.
  - The `analyzer_node` detects this signal and routes execution to the `approval_node`.
  - The workflow pauses at `approval_node` to ask the user for permission before fetching new data.
  - This prevents uncontrolled recursion loops and keeps the user in control of data fetching.

- **Visualization Workflow**:
  - If `AnalyzerAgent` sets `needs_visualization=True`, the graph routes to `visualization_node`.
  - The workflow pauses before `visualization_node` to ask the user: "Do you want to generate a visualization?".
  - If approved, `visualization_node` uses an LLM to generate Plotly Express code based on the data summary and user query.
  - The generated figure is stored in `state.visualization` and displayed in the UI.

- **Sub-agents and tools**
  - `AnalyzerAgent` (`src/sportsagent/agents/analyzeragent.py`):
    - **Type**: ReAct Agent.
    - **Role**: Performs statistical analysis and judges data relevance.
    - **Tools**:
      - `describe_dataset`: Computes numerical summary statistics.
      - `explain_data`: Generates narrative EDA summary.
      - `compare_performance`: Calculates comparison metrics between players.
      - `request_more_data`: Signals the need for additional data (triggers graph loop).
    - **Behavior**:
      - Judges if data is sufficient for the user's request.
      - If comparison is needed but data is missing, requests more data.
      - If data is sufficient, performs analysis and generates a response.
      - **New Behavior**: If the user just loaded data, avoids immediate full analysis. Instead, suggests 3 visualization ideas and offers to fetch more data.
      - Can flag the need for visualization (via `needs_visualization` state).
      - **Robustness**: Includes fallback detection for `REQUEST_MORE_DATA` in text output if tool calling fails.

- **Streamlit Application** (`src/sportsagent/main_st.py`):
  - **Architecture**: Mirrors the Chainlit app by using the same LangGraph workflow (`playereval`).
  - **Features**:
  - **Features**:
    - **Workflow Tracing**: Displays the sequence of executed nodes in the sidebar.
    - **Data Inspection**: Shows the currently retrieved dataframe in an expander at the bottom of the UI.
    - **Visualization**: Renders Plotly charts generated by the workflow.
    - **HITL**: Supports "visualization" and "approval" interrupts with UI buttons.
    - **State Persistence**: Manually persists `retrieved_data` and `conversation_history` in `st.session_state` to support multi-turn conversations and context retention.

## State, Artifacts, and Token-Cost Strategy

- **Custom state model**: `ChatbotState` (`src/sportsagent/models/chatbotstate.py`)
  - Fields:
    - `session_id`: Unique session identifier.
    - `user_query`: Current user query (updated during retrieval loops).
    - `parsed_query`: Structured intent (includes `players`, `positions`, `statistics`, etc.).
    - `retrieved_data`: Canonical place for raw tabular data (`list[dict]`). **Note**: Changed from DataFrame to list of dicts for msgpack serializability.
    - `generated_response`: Final text response.
    - `needs_visualization`: Boolean flag indicating if the next step should generate charts.
    - `visualization`: Stores the generated Plotly figure as a JSON-serialized dictionary (for msgpack compatibility).
    - `conversation_history`: Tracks past interactions.

- **Dataframe tools** (`src/sportsagent/tools/dataframe.py`)
  - `explain_data`: Returns narrative summary.
  - `describe_dataset`: Returns summary stats artifact.
  - `compare_performance`: Returns comparison metrics artifact.
  - **Philosophy**: Raw data lives in `state.retrieved_data`. Tools consume it via injection and return concise summaries or artifacts. Large tables are NOT dumped into the chat context.

## Future Plans

- **Memory Node**:
  - Re-integrate the memory node to persist conversation context more effectively.
- **Refinement**:
  - Explore structured output for the `AnalyzerAgent` to explicitly separate "analysis", "judgment", and "visualization_request".
  - **Abstraction Refactor**: Consider removing the `AnalyzerAgent` class wrapper and defining the agent graph directly in `analyzernode.py` or a dedicated module to simplify the architecture and remove the extra abstraction layer.
  - **Visualization Trigger**: Replace the string-matching logic (`"visualiz" in response`) with a structured output or dedicated tool call (`request_visualization`) for deterministic behavior.
